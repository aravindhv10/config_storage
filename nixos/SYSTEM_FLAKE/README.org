* hardware-configuration
#+begin_src nix :mkdirp yes :tangle ./nixos/hardware-configuration.nix
  {
    config,
    lib,
    pkgs,
    modulesPath,
    unstable,
    ...
  }: {
    imports = [(modulesPath + "/installer/scan/not-detected.nix")];

    hardware.cpu.amd.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;

    fileSystems."/" = {
      device = "/dev/disk/by-partlabel/linux";
      fsType = "btrfs";
      options = ["subvol=@" "compress=zstd:3" "autodefrag"];
    };

    fileSystems."/boot" = {
      device = "/dev/disk/by-partlabel/efi";
      fsType = "vfat";
      options = ["fmask=0077" "dmask=0077"];
    };

    swapDevices = [{device = "/dev/disk/by-partlabel/swap0";}];
  }
#+end_src

* boot configs
#+begin_src nix :mkdirp yes :tangle ./nixos/boot_config.nix
  {
    config,
    lib,
    pkgs,
    modulesPath,
    unstable,
    ...
  }: {
    boot = {
      loader = {
        efi = {
          canTouchEfiVariables = true;
          efiSysMountPoint = "/boot/efi";
        } ;

        grub = {
          device = "/dev/nvme0n1";
          efiInstallAsRemovable = false;
          efiSupport = true;
        } ;

        systemd-boot.enable = false;
      };

      tmp = {
        tmpfsSize = "60%";
        useTmpfs = true;
      };

      initrd = {
        availableKernelModules = ["nvme" "xhci_pci" "ahci" "uas" "sd_mod"];
        kernelModules = [];
      };

      extraModulePackages = [];
      kernelModules = ["kvm-amd" "amdgpu"];
      kernelPackages = pkgs.linuxKernel.packages.linux_xanmod_latest;
      kernelParams = ["zswap.enabled=1" "zswap.max_pool_percent=80"];

      # kernelPackages = pkgs.linuxPackages_6_14; 
      # kernelPackages = pkgs.linuxPackages_6_15; 
      # kernelPackages = pkgs.linuxPackages_6_16; 
      # kernelPackages = pkgs.linuxPackages_6_17; 

      # kernelPackages =
      # let
      #     linux_sgx_pkg = { fetchurl, buildLinux, ... } @ args:
      #         buildLinux (
      #             args // rec {
      #                 version = "6.13.11-xanmod1" ;
      #                 modDirVersion = version;
      #                 src = /home/asd/GITLAB/xanmod/linux-6.13.11.tar; # /home/asd/GITLAB/xanmod/linux-6.12.19.tar;
      #                 kernelPatches = [];
      #                 extraConfig = ''
      #                 '';
      #                 extraMeta.branch = version ;
      #             } // (args.argsOverride or {})
      #         );
      #     linux_sgx = pkgs.callPackage linux_sgx_pkg{};
      # in 
      #     pkgs.recurseIntoAttrs (pkgs.linuxPackagesFor linux_sgx);

    };

  }
#+end_src

* Network config
#+begin_src nix :mkdirp yes :tangle ./nixos/network_config.nix
  {
    config,
    lib,
    pkgs,
    modulesPath,
    unstable,
    ...
  }: {
    networking = {
      # Define your hostname.
      hostName = "nixos";

      hosts = {
        "192.168.122.2" = ["vm"];
      };

      firewall.enable = false;
      networkmanager.enable = true;
      nftables.enable = true;
      timeServers = ["ntp.example.com" "time.google.com"];
      useDHCP = lib.mkDefault true;

      # interfaces.wlp1s0.useDHCP = lib.mkDefault true;
      # wireless.enable = true;
      # proxy.default = "http://user:password@proxy:port/";
      # proxy.noProxy = "127.0.0.1,localhost,internal.domain";
      # firewall.allowedTCPPorts = [ ... ];
      # firewall.allowedUDPPorts = [ ... ];
    };
  }
#+end_src

* Language and locale
#+begin_src nix :mkdirp yes :tangle ./nixos/i18n.nix
  {
    config,
    lib,
    pkgs,
    modulesPath,
    unstable,
    ...
  }: {
    i18n = {
      defaultLocale = "en_IN";
      extraLocaleSettings = {
        LC_ADDRESS = "en_IN";
        LC_IDENTIFICATION = "en_IN";
        LC_MEASUREMENT = "en_IN";
        LC_MONETARY = "en_IN";
        LC_NAME = "en_IN";
        LC_NUMERIC = "en_IN";
        LC_PAPER = "en_IN";
        LC_TELEPHONE = "en_IN";
        LC_TIME = "en_IN";
      };
    };
  }
#+end_src

* Services
#+begin_src nix :mkdirp yes :tangle ./nixos/services.nix
  {
    config,
    lib,
    pkgs,
    modulesPath,
    unstable,
    ...
  }: {

    services = {
      displayManager.sessionPackages = [unstable.wayfire];
      chrony.enable = true;
      openssh.enable = true;
      printing.enable = true;
      thermald.enable = true;
      libinput.enable = true;

      flatpak = {
        enable = true;
        package = unstable.flatpak;
      };

      desktopManager = {
        plasma6.enable = true;
        gnome.enable = true;
      };

      pipewire = {
        enable = true;
        alsa.enable = true;
        alsa.support32Bit = true;
        pulse.enable = true;
        # If you want to use JACK applications, uncomment this
        #jack.enable = true;

        # use the example session manager (no others are packaged yet so this is enabled by default,
        # no need to redefine it in your config for now)
        #media-session.enable = true;
      };


      # Enable the X11 windowing system.
      # You can disable this if you're only using the Wayland session.
      # xserver = {
      #     enable = true;
      #     videoDrivers = ["amdgpu"];
      #     xkb = {
      #         layout = "us";
      #         variant = "";
      #     };
      # };

      displayManager = {
        gdm.enable = false;
        sddm = {
          enable = false;
          wayland.enable = false;
          settings.General.DisplayServer = "wayland";
        };
      };

      greetd = {
        enable = true;
        settings = rec {
          initial_session = {
            command = "${pkgs.uwsm}/bin/uwsm start ${pkgs.wayfire}/bin/wayfire";
            user = "asd";
          };
          default_session = initial_session;
        };
      };

      dnsmasq = {
        enable = true;
        alwaysKeepRunning = true;
        resolveLocalQueries = true;
        settings = {
          server = [
            "1.0.0.1"
            "1.1.1.1"
            "149.112.112.112"
            "185.228.168.9"
            "185.228.169.9"
            "192.168.1.254"
            "208.67.220.220"
            "208.67.222.222"
            "4.2.2.2"
            "76.223.122.150"
            "76.76.10.0"
            "76.76.19.19"
            "76.76.2.0"
            "8.8.4.4"
            "8.8.8.4"
            "8.8.8.8"
            "94.140.14.14"
            "94.140.15.15"
            "9.9.9.9"
          ];
          local-service = true; # Accept DNS queries only from hosts whose address is on a local subnet
          log-queries = true; # Log results of all DNS queries
          bogus-priv = true; # Don't forward requests for the local address ranges (192.168.x.x etc) to upstream nameservers
          domain-needed = true; # Don't forward requests without dots or domain parts to upstream nameservers
          all-servers = true;
          dnssec = true; # Enable DNSSEC
          # DNSSEC trust anchor. Source: https://data.iana.org/root-anchors/root-anchors.xml
          trust-anchor = ".,20326,8,2,E06D44B80B8F1D39A95C0B0D7C65D08458E880409BBC683457104237C7F8EC8D";
          dhcp-range = ["192.168.122.101,192.168.122.200"];
        };
      };
    };
  }
#+end_src

* Environment variables
#+begin_src nix :mkdirp yes :tangle ./nixos/environment.nix
  {
    config,
    lib,
    pkgs,
    modulesPath,
    unstable,
    ...
  }: {
    environment = {
      etc."greetd/environments".text = ''
        wayfire
        fish
        bash
      '';

      variables = {
        ROC_ENABLE_PRE_VEGA = "1";
        EDITOR = "hx";
        QT_SCALE_FACTOR = "1.25";
      };

      gnome.excludePackages = with pkgs; [
        atomix # puzzle game
        cheese # webcam tool
        epiphany # web browser
        geary # email reader
        gedit # text editor
        gnome-characters
        gnome-music
        gnome-photos
        gnome-terminal
        gnome-tour
        hitori # sudoku game
        iagno # go game
        tali # poker game
        totem # video player
        seahorse
      ];
    };
  }
#+end_src

* Main config
#+begin_src nix :mkdirp yes :tangle ./nixos/configuration.nix
  {
    config,
    lib,
    pkgs,
    modulesPath,
    unstable,
    ...
  }: {
    imports = [
      ./hardware-configuration.nix
      ./boot_config.nix
      ./network_config.nix
      ./i18n.nix
      ./services.nix
      ./environment.nix
    ];

    security.rtkit.enable = true;
    time.timeZone = "Asia/Kolkata";

    nixpkgs = {
      hostPlatform = lib.mkDefault "x86_64-linux";
      config.allowUnfree = true;
    };

    programs = {
      firefox.enable = true;
      virt-manager.enable = true;

      niri = {
        enable = true;
        package = unstable.niri;
      };

      hyprland = {
        enable = true;
        package = unstable.hyprland;
        withUWSM = true; # recommended for most users
        # withUWSM = false; # recommended for most users
        xwayland.enable = true; # Xwayland can be disabled.
      };

      wayfire = {
        enable = true;
        # package = unstable.wayfire;
        plugins = [
          pkgs.wayfirePlugins.wayfire-plugins-extra
          pkgs.wayfirePlugins.wcm
          pkgs.wayfirePlugins.wf-shell
        ];
      };

      fish = {
        enable = true;
        package = unstable.fish;
      };

      zsh = {
        enable = true;
        ohMyZsh = {
          enable = true;
          plugins = [
            "eza"
            "fzf"
            "git"
            "procs"
            "starship"
            "systemd"
            "zoxide"
          ];
          theme = "robbyrussell";
        };
      };
    };

    # services = {
    #   displayManager.sessionPackages = [unstable.wayfire];
    #   flatpak = {
    #     enable = true;
    #     package = unstable.flatpak;
    #   };
    # };

    documentation = {
      enable = true;
      man.enable = true;
      dev.enable = true;
    };

    users = {
      users.asd = {
        isNormalUser = true;
        shell = unstable.fish;
        description = "asd";
        extraGroups = ["networkmanager" "wheel" "audio" "incus-admin" "libvirtd"];
        packages = with pkgs; [
          kdePackages.kate
          # thunderbird
        ];
      };

      defaultUserShell = pkgs.zsh;
      groups.libvirtd.members = ["asd"];
    };

    virtualisation = {
      libvirtd.enable = true;
      spiceUSBRedirection.enable = true;
      containers.enable = true;
      incus.enable = true;

      podman = {
        enable = true;
        # Create a `docker` alias for podman, to use it as a drop-in replacement
        dockerCompat = true;
        # Required for containers under podman-compose to be able to talk to each other.
        defaultNetwork.settings.dns_enabled = true;
      };
    };

    environment.systemPackages = with pkgs; [
      acpi
      alsa-utils
      appstream
      azure-cli
      blend2d
      brave
      bridge-utils
      buildah
      cargo
      cargo-info
      catppuccin-kde
      chromium
      clinfo
      cmake
      conky
      curl
      dig
      distrobox
      dive
      dmidecode
      dnsmasq
      docker-compose
      ffmpeg
      ffmpeg.dev
      file
      foot
      fuse3
      gcc
      gcc14Stdenv
      gdk-pixbuf
      gdm
      git
      git-lfs
      glib
      gpgme
      graphicsmagick-imagemagick-compat
      grc
      grim
      grub2
      grub2_efi
      gsettings-desktop-schemas
      jq
      json-glib
      kdePackages.kolourpaint
      kitty
      libarchive
      libcap
      libgcc
      libinput
      librsvg
      libseccomp
      libxml2
      lldb
      llvmPackages_20.clang
      llvmPackages_20.clang-tools
      lxc
      man-pages
      man-pages-posix
      mate.mate-panel
      mate.mate-panel-with-applets
      mate.mate-session-manager
      meson
      mpv
      networkmanagerapplet
      networkmanager-openconnect
      nh
      nix-index
      nix-ld
      openconnect
      openssl
      parted
      pavucontrol
      pciutils
      pkg-config
      podman
      podman-compose
      podman-tui
      poppler-utils
      qbittorrent-enhanced
      qpdf
      rust-analyzer
      rust-bindgen
      rustc
      rustfmt
      shellcheck
      swayosd
      texliveFull
      thunderbird
      tree
      unzip
      uwsm
      vim
      virt-viewer
      vscode-fhs
      waybar
      wayland
      wayland-protocols
      wf-recorder
      wget
      wl-clipboard
      wlogout
      zip
      zstd

      (unstable.python313.withPackages (ps:
        with ps; [
          albumentations
          datafusion
          einops
          fastapi
          flask
          gnumake
          h5py
          inotify-simple
          ipython
          jax
          lightning
          matplotlib
          multiprocess
          numpy
          onnx
          onnxruntime
          opencv-python
          pillow
          protobuf
          python-multipart
          requests
          safetensors
          tensorboard
          tensorboardx
          timm
          torch
          torchmetrics
          torchvision
          transformers
          uvicorn
          yt-dlp
        ]))

      unstable.alacritty
      unstable.alejandra
      unstable.aria2
      unstable.atuin
      unstable.bat
      unstable.bottom
      unstable.brightnessctl
      unstable.byobu
      unstable.clapboard
      unstable.delta
      unstable.difftastic
      unstable.dust
      unstable.emacs30
      unstable.emacs-lsp-booster
      unstable.eza
      unstable.fd
      unstable.fzf
      unstable.gitui
      unstable.helix
      unstable.inkscape
      unstable.lapce
      unstable.lsd
      unstable.lyx
      unstable.mako
      unstable.miniserve
      unstable.mpvpaper
      unstable.neovim
      unstable.nixfmt
      unstable.nushell
      unstable.openblas
      unstable.openblas.dev
      unstable.opencv4
      unstable.pdf2svg
      unstable.procs
      unstable.quickshell
      unstable.rclone
      unstable.ripgrep
      unstable.ruff
      unstable.rustlings
      unstable.skim
      unstable.spice-gtk
      unstable.squashfsTools
      unstable.starship
      unstable.swww
      unstable.television
      unstable.texlab
      unstable.tmux
      unstable.uv
      unstable.wezterm
      unstable.wine
      unstable.wlsunset
      unstable.wluma
      unstable.yazi
      unstable.ydotool
      unstable.zed-editor
      unstable.zoxide

      (unstable.gnuplot.override { 
          withLua = true; 
          withTeXLive = true; # This provides the necessary TikZ support
      })

      (writeCBin "YDOTOOL_DAEMON" ''

        #include <stdio.h>
        #include <stdlib.h>
        #include <string.h>
        #include <unistd.h>

        #define SIZE_BUFFER (1 << 20)

        static char BUFFER[SIZE_BUFFER];
        static int BUFFER_CURRENT;
        static char SUDO_ASKPASS[] = "/SUDO_ASKPASS";

        static char sudo[] = "sudo";
        static char minus_b[] = "-b";
        static char minus_E[] = "-E";
        static char minus_A[] = "-A";
        static char prog[] = "ydotoold";
        static char *args[7];

        static inline size_t align(size_t const val) {
          size_t const newval = val & (~7);
          return newval == val ? val : newval + 8;
        }

        static inline char *myalloc(size_t const insize) {
          BUFFER_CURRENT = align(BUFFER_CURRENT);
          char *ret = BUFFER + BUFFER_CURRENT;
          BUFFER_CURRENT += align(insize);
          return ret;
        }

        static inline char *get_sudo_askpass() {
          char *HOME = getenv("HOME");
          size_t len_HOME = strlen(/*const char *s =*/HOME);
          char *ret = myalloc(/*size_t const insize =*/len_HOME + sizeof(SUDO_ASKPASS));

          /*void **/ memcpy(/*void dest[restrict .n] =*/ret,
                            /*const void src[restrict .n] =*/HOME,
                            /*size_t n =*/len_HOME);

          /*void **/ memcpy(/*void dest[restrict .n] =*/ret + len_HOME,
                            /*const void src[restrict .n] =*/SUDO_ASKPASS,
                            /*size_t n =*/sizeof(SUDO_ASKPASS));

          return ret;
        }

        static inline char *get_ydotool_args() {
          uid_t const uid = getuid();
          gid_t const gid = getgid();
          /*static inline*/ char *buf = myalloc(/*size_t const insize =*/128);
          sprintf(buf, "--socket-own=%d:%d", uid, gid);
          return buf;
        }

        int main() {
          char *final_sudo_askpass = get_sudo_askpass();
          /*int*/ setenv(/*const char *name =*/"SUDO_ASKPASS",
                         /*const char *value =*/final_sudo_askpass,
                         /*int overwrite =*/1);

          unsigned char i = 0;
          args[i] = sudo;
          ++i;
          // args[i] = minus_b;
          // ++i;
          args[i] = minus_E;
          ++i;
          args[i] = minus_A;
          ++i;
          args[i] = prog;
          ++i;
          args[i] = get_ydotool_args();
          ++i;
          args[i] = NULL;
          ++i;

          /*int*/ execvp(args[0], args);

          return 0;
        }

      '')

      (writeCBin "M_PLUS" ''

        #include <unistd.h>

        static char *const args[] = {"ydotool", "mousemove", "-w", "--",
                                     "0",       "2",         NULL};

        int main() {
          int ret = execvp(args[0], args);
          return ret;
        }

      '')

      (writeCBin "M_MINUS" ''

        #include <unistd.h>

        static char *const args[] = {"ydotool", "mousemove", "-w", "--",
                                     "0",       "-2",         NULL};

        int main() {
          int ret = execvp(args[0], args);
          return ret;
        }

      '')

      (writeCBin "M_C_PLUS" ''

        #include <unistd.h>

        static char *const args[] = {"swayosd-client", "--brightness=raise", NULL};

        int main() {
          int ret = execvp(args[0], args);
          return ret;
        }

      '')

      (writeCBin "M_C_MINUS" ''

        #include <unistd.h>

        static char *const args[] = {"swayosd-client", "--brightness=lower", NULL};

        int main() {
          int ret = execvp(args[0], args);
          return ret;
        }

      '')

      (writeCBin "M_C_LEFTBRACE" ''

        #include <unistd.h>

        static char *const args[] = {"swayosd-client", "--max-volume=255", "--output-volume=-10", NULL};

        int main() {
          int ret = execvp(args[0], args);
          return ret;
        }

      '')

      (writeCBin "M_C_RIGHTBRACE" ''

        #include <unistd.h>

        static char *const args[] = {"swayosd-client", "--max-volume=255", "--output-volume=+10", NULL};

        int main() {
          int ret = execvp(args[0], args);
          return ret;
        }

      '')

      (writeCBin "M_C_ESC" ''

        #include <unistd.h>

        static char * const args[] = {"wlogout", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_F1" ''

        #include <unistd.h>

        static char * const args[] = {"alacritty", "msg", "create-window", "-e", "byobu-tmux", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_F2" ''

        #include <unistd.h>

        static char * const args[] = {"alacritty", "msg", "create-window", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_F3" ''

        #include <unistd.h>

        static char * const args[] = {"emacsclient", "-c", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_C_1" ''

        #include <unistd.h>
        #include <sys/wait.h>

        int start (char * const * argv) {
            int ret = execvp(argv[0], argv);
            return ret;
        }

        int do_start (char * const * argv) {
            pid_t p_start;
            int ret_start;
            p_start = fork();
            if(p_start == 0){
                ret_start = start (argv);
                return ret_start;
            }
            waitpid(p_start, NULL, 0);
            return 0;
        }

        static char * const args[] = {"emacs", NULL};

        int main () {
            do_start(args);
            return 0;
        }

      '')

      (writeCBin "M_C_2" ''

        #include <unistd.h>

        static char * const args[] = {"emacsclient", "-c", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "TY" ''

        #include <unistd.h>
        #include <sys/wait.h>

        int start (char * const * argv) {
            int ret = execvp(argv[0], argv);
            return ret;
        }

        int do_start (char * const * argv) {
            pid_t p_start;
            int ret_start;
            p_start = fork();
            if(p_start == 0){
                ret_start = start (argv);
                return ret_start;
            }
            waitpid(p_start, NULL, 0);
            return 0;
        }

        static char * const args[] = {"byobu-tmux", NULL};

        int main () {
            do_start(args);
            return 0;
        }

      '')

      (writeCBin "enter_emacs_flatpak" ''

        #include <unistd.h>

        static char * const args[] = {"flatpak", "run", "--command=bash", "org.gnu.emacs", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_C_Q" ''

        #include <unistd.h>

        static char * const args[] = {"wezterm", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_C_W" ''

        #include <unistd.h>

        static char * const args[] = {"alacritty" , "msg" , "create-window" , "-e" , "byobu-tmux" , NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_C_E" ''

        #include <unistd.h>

        static char * const args[] = {"alacritty" , "msg" , "create-window" , "-e" , "enter_emacs_flatpak" , NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_C_R" ''

        #include <unistd.h>

        static char * const args[] = {"footclient" , "-e" , "enter_emacs_flatpak" , NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_C_T" ''

        #include <unistd.h>
        #include <sys/wait.h>

        int foot_server () {
            static char * const args[] = {"foot" , "-s" , NULL};
            int ret = execvp(args[0], args);
            return ret;
        }

        int alacritty_server () {
            static char * const args[] = {"alacritty" , "-e" , "TY" , NULL};
            int ret = execvp(args[0], args);
            return ret;
        }

        int both () {
            pid_t p_foot;
            pid_t p_alacritty;
            int ret_foot;
            int ret_alacritty;

            p_foot = fork();
            if(p_foot == 0){
                ret_foot = foot_server ();
                return ret_foot;
            }

            p_alacritty = fork();
            if(p_alacritty == 0){
                ret_alacritty = alacritty_server ();
                return ret_alacritty;
            }

            waitpid(p_foot, NULL, 0);
            waitpid(p_alacritty, NULL, 0);

            return 0;
        }

        int main () {
            both();
            return 0;
        }

      '')

      (writeCBin "M_C_A" ''

        #include <unistd.h>

        static char * const args[] = {"firefox" ,  NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_C_S" ''

        #include <unistd.h>

        static char * const args[] = {"chromium", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_C_D" ''

        #include <unistd.h>

        static char * const args[] = {"dolphin" , NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_C_F" ''

        #include <unistd.h>

        static char * const args[] = {"pavucontrol" , NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_C_G" ''

        #include <unistd.h>

        static char * const args[] = {"footclient", "nmtui" , NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_Q" ''

        #include <unistd.h>

        static char * const args[] = {"amixer", "set", "Master,0", "0%", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_W" ''

        #include <unistd.h>

        static char * const args[] = {"amixer", "set", "Master,0", "11%", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_E" ''

        #include <unistd.h>

        static char * const args[] = {"amixer", "set", "Master,0", "22%", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_R" ''

        #include <unistd.h>

        static char * const args[] = {"amixer", "set", "Master,0", "33%", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_T" ''

        #include <unistd.h>

        static char * const args[] = {"amixer", "set", "Master,0", "44%", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_Y" ''

        #include <unistd.h>

        static char * const args[] = {"amixer", "set", "Master,0", "55%", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_U" ''

        #include <unistd.h>

        static char * const args[] = {"amixer", "set", "Master,0", "66%", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_I" ''

        #include <unistd.h>

        static char * const args[] = {"amixer", "set", "Master,0", "77%", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_O" ''

        #include <unistd.h>

        static char * const args[] = {"amixer", "set", "Master,0", "88%", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_P" ''

        #include <unistd.h>

        static char * const args[] = {"amixer", "set", "Master,0", "100%", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_GRAVE" ''

        #include <unistd.h>

        // static char * const args[] = {"brightnessctl", "set", "0%", NULL};
        static char * const args[] = {"swayosd-client", "--brightness=0", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_1" ''

        #include <unistd.h>

        // static char * const args[] = {"brightnessctl", "set", "10%", NULL};
        static char * const args[] = {"swayosd-client", "--brightness=10", NULL};


        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_2" ''

        #include <unistd.h>

        // static char * const args[] = {"brightnessctl", "set", "20%", NULL};
        static char * const args[] = {"swayosd-client", "--brightness=20", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_3" ''

        #include <unistd.h>

        // static char * const args[] = {"brightnessctl", "set", "30%", NULL};
        static char * const args[] = {"swayosd-client", "--brightness=30", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_4" ''

        #include <unistd.h>

        // static char * const args[] = {"brightnessctl", "set", "40%", NULL};
        static char * const args[] = {"swayosd-client", "--brightness=40", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_5" ''

        #include <unistd.h>

        // static char * const args[] = {"brightnessctl", "set", "50%", NULL};
        static char * const args[] = {"swayosd-client", "--brightness=50", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_6" ''

        #include <unistd.h>

        // static char * const args[] = {"brightnessctl", "set", "60%", NULL};
        static char * const args[] = {"swayosd-client", "--brightness=60", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_7" ''

        #include <unistd.h>

        // static char * const args[] = {"brightnessctl", "set", "70%", NULL};
        static char * const args[] = {"swayosd-client", "--brightness=70", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_8" ''

        #include <unistd.h>

        // static char * const args[] = {"brightnessctl", "set", "80%", NULL};
        static char * const args[] = {"swayosd-client", "--brightness=80", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_9" ''

        #include <unistd.h>

        // static char * const args[] = {"brightnessctl", "set", "90%", NULL};
        static char * const args[] = {"swayosd-client", "--brightness=90", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')

      (writeCBin "M_A_0" ''

        #include <unistd.h>

        // static char * const args[] = {"brightnessctl", "set", "100%", NULL};
        static char * const args[] = {"swayosd-client", "--brightness=100", NULL};

        int main () {
            int ret = execvp(args[0], args);
            return ret;
        }

      '')
    ];

    system.stateVersion = "24.11";
  }
#+end_src

* Flake
#+begin_src nix :mkdirp yes :tangle ./nixos/flake.nix
  {
    description = "NixOS Flake Configuration";

    inputs = {
      # Standard NixOS stable channel
      nixpkgs.url = "github:nixos/nixpkgs/nixos-25.11";
      # Unstable channel for bleeding edge packages
      nixpkgs-unstable.url = "github:nixos/nixpkgs/nixos-unstable";
    };

    outputs = { self, nixpkgs, nixpkgs-unstable, ... }@inputs:
      let
        system = "x86_64-linux";
        # Define unstable for use in modules
        unstable = import nixpkgs-unstable {
          inherit system;
          config.allowUnfree = true;
        };
      in {
        nixosConfigurations.nixos = nixpkgs.lib.nixosSystem {
          inherit system;
          # specialArgs allows you to pass variables to all imported modules
          specialArgs = { inherit inputs unstable; };
          modules = [
            ./configuration.nix
          ];
        };
      };
  }
#+end_src

* Script to rebuild and switch

** On tmp
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./nixos/rebuild_switch.sh
  export TMPDIR='/tmp'
  nixos-rebuild switch --flake '.#nixos'
  echo '#### DONE ####'
#+end_src

** On var/tmp
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./nixos/rebuild_switch_safe.sh
  export TMPDIR='/var/tmp'
  nixos-rebuild switch --flake '.#nixos'
  echo '#### DONE ####'
#+end_src

* Script to rebuild and boot

** On /tmp
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./nixos/rebuild_boot.sh
  export TMPDIR='/tmp'
  nixos-rebuild boot --flake '.#nixos'
  echo '#### DONE ####'
#+end_src

** On /var/tmp
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./nixos/rebuild_boot_safe.sh
  export TMPDIR='/var/tmp'
  nixos-rebuild boot --flake '.#nixos'
  echo '#### DONE ####'
#+end_src

* Script to push this config to etc
#+begin_src sh :shebang #!/bin/sh :results output :mkdirp yes :tangle ./setup.sh
  cd "$(dirname -- "${0}")"
  rsync -avh --progress './nixos/' '/etc/nixos/'
#+end_src

* git management scripts
#+begin_src sh :shebang #!/bin/sh :results output :mkdirp yes :tangle ./.git.sh
  . "${HOME}/important_functions.sh"

  NIXADD () {
      alejandra "./nixos/${1}"
      GITADD "nixos/${1}"
  }

  CLEAN '.git.sh'

  NIXADD 'boot_config.nix'
  NIXADD 'configuration.nix'
  NIXADD 'environment.nix'
  NIXADD 'flake.nix'
  NIXADD 'hardware-configuration.nix'
  NIXADD 'i18n.nix'
  NIXADD 'network_config.nix'
  NIXADD 'services.nix'

  GITADD 'nixos/rebuild_boot_safe.sh'
  GITADD 'nixos/rebuild_boot.sh'
  GITADD 'nixos/rebuild_switch_safe.sh'
  GITADD 'nixos/rebuild_switch.sh'
  GITADD 'README.org'
  GITADD 'setup.sh'

  git status ; git commit -m 'Started converting to flake'
  "${HOME}/SSH/KEYS/PERSONAL_LAPTOP_PERSONAL_GITHUB/setup.sh" ; git push
#+end_src

* COMMENT WORK SPACE

** git management
#+begin_src emacs-lisp :results silent
  (save-buffer)
  (org-babel-tangle)
  (async-shell-command "
          './.git.sh'
  " "log" "err")
#+end_src

** Push to system
#+begin_src emacs-lisp :results silent
  (async-shell-command "
    sudo -A './setup.sh'
  " "log" "err")
#+end_src

