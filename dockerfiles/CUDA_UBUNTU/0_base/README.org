* Scripts to manage
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  . '../../../shell_functions/important_functions.sh'
  GITADD 'README.org'
  P_CLEAN '.git.sh'
  P_CLEAN 'README.org~'
#+end_src

* Prepare and add the docker functions file to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'host.image_names.sh'
#+end_src

* Host scripts

** Important envs
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  IMAGE_NAME='debtestrust'
#+end_src

** Important functions

*** Build image
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  BUILD_CONTAINER () {
      CMD='sudo -A docker'
      which buildah && CMD='buildah'
      ${CMD} build -t "${IMAGE_NAME}" -f "./Dockerfile" .
  }
#+end_src

*** Run image
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  RUN_CONTAINER () {
      CMD='sudo -A docker'
      which podman && CMD='podman'
      ${CMD} run -it --rm -v "$(realpath .):/data" "${IMAGE_NAME}" bash
  }
#+end_src

* Scripts to build and run

** Build image

*** Add file to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'image_build.sh'
#+end_src

*** Actual script
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./image_build.sh
  cd "$(dirname -- "${0}")"
  . './host.image_names.sh'
  BUILD_CONTAINER
#+end_src

** Run image

*** Add file to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'image_run.sh'
#+end_src

*** Actual script
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./image_run.sh
  cd "$(dirname -- "${0}")"
  . './host.image_names.sh'
  RUN_CONTAINER
#+end_src

* Prepare and add the dockerfile to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'Dockerfile'
#+end_src

* Basic image config

** Main base image
#+begin_src conf :tangle ./Dockerfile
  FROM nvidia/cuda:12.8.1-cudnn-devel-ubuntu24.04
#+end_src

** Basic configs
#+begin_src conf :tangle ./Dockerfile
  ENV HOME='/root'
  ENV DEBIAN_FRONTEND='noninteractive'
  WORKDIR '/root'
  USER root
#+end_src

* Install rust

** Install tools to download and install rust
#+begin_src conf :tangle ./Dockerfile
  RUN \
      --mount=target=/var/lib/apt/lists,type=cache,sharing=locked \
      --mount=target=/var/cache/apt,type=cache,sharing=locked \
      echo 'START apt-get stuff' \
      && apt-get -y update \
      && apt-get install -y \
          'curl' \
          'wget' \
      && echo 'DONE apt-get stuff' ;
#+end_src

** Setup ENV for rust
#+begin_src conf :tangle ./Dockerfile
  ENV RUSTUP_HOME='/usr/local/rustup'
  ENV CARGO_HOME='/usr/local/cargo'
  ENV PATH='/usr/local/cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
  ENV RUST_VERSION='1.91.1'
#+end_src

** Download and install rust
#+begin_src conf :tangle ./Dockerfile
  RUN set -eux; \
      \
      arch="$(dpkg --print-architecture)"; \
      case "$arch" in \
          'amd64') \
              rustArch='x86_64-unknown-linux-gnu'; \
              rustupSha256='20a06e644b0d9bd2fbdbfd52d42540bdde820ea7df86e92e533c073da0cdd43c'; \
              ;; \
          'armhf') \
              rustArch='armv7-unknown-linux-gnueabihf'; \
              rustupSha256='3b8daab6cc3135f2cd4b12919559e6adaee73a2fbefb830fadf0405c20231d61'; \
              ;; \
          'arm64') \
              rustArch='aarch64-unknown-linux-gnu'; \
              rustupSha256='e3853c5a252fca15252d07cb23a1bdd9377a8c6f3efa01531109281ae47f841c'; \
              ;; \
          'i386') \
              rustArch='i686-unknown-linux-gnu'; \
              rustupSha256='a5db2c4b29d23e9b318b955dd0337d6b52e93933608469085c924e0d05b1df1f'; \
              ;; \
          'ppc64el') \
              rustArch='powerpc64le-unknown-linux-gnu'; \
              rustupSha256='acd89c42b47c93bd4266163a7b05d3f26287d5148413c0d47b2e8a7aa67c9dc0'; \
              ;; \
          's390x') \
              rustArch='s390x-unknown-linux-gnu'; \
              rustupSha256='726b7fd5d8805e73eab4a024a2889f8859d5a44e36041abac0a2436a52d42572'; \
              ;; \
          'riscv64') \
              rustArch='riscv64gc-unknown-linux-gnu'; \
              rustupSha256='09e64cc1b7a3e99adaa15dd2d46a3aad9d44d71041e2a96100d165c98a8fd7a7'; \
              ;; \
          ,*) \
              echo >&2 "unsupported architecture: $arch"; \
              exit 1; \
              ;; \
      esac; \
      \
      url="https://static.rust-lang.org/rustup/archive/1.28.2/${rustArch}/rustup-init"; \
      wget --progress=dot:giga "$url"; \
      echo "${rustupSha256} *rustup-init" | sha256sum -c -; \
      \
      chmod +x rustup-init; \
      ./rustup-init -y --no-modify-path --profile minimal --default-toolchain $RUST_VERSION --default-host ${rustArch}; \
      rm rustup-init; \
      chmod -R a+w $RUSTUP_HOME $CARGO_HOME; \
      \
      rustup --version; \
      cargo --version; \
      rustc --version;
#+end_src

** Add the standard library source
#+begin_src conf :tangle ./Dockerfile
  RUN rustup component add rust-src
  RUN rustup component add rust-analyzer
  RUN rustup component add rustfmt
#+end_src

* COMMENT work space
#+begin_src emacs-lisp :results silent
  (save-buffer)
  (org-babel-tangle)
  (async-shell-command "
      './.git.sh'
  " "log" "err")
#+end_src
