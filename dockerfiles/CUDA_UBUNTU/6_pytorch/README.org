* Scripts to manage
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  . '../../../shell_functions/important_functions.sh'
  GITADD 'README.org'
  P_CLEAN '.git.sh'
  P_CLEAN 'README.org~'
#+end_src

* Prepare and add the docker functions file to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'host.image_names.sh'
#+end_src

* Host scripts

** Important envs
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  # IMAGE_NAME='debtestrustzshhelix'
  IMAGE_NAME='debtestrustzshhelixpytorch2'
  LISTEN_PORT='8080'
#+end_src

** Important functions

*** Build image
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  BUILD_CONTAINER () {
      CMD='sudo -A docker'
      which buildah && CMD='buildah'
      ${CMD} build -t "${IMAGE_NAME}" -f "./Dockerfile" .
  }
#+end_src

*** Run image
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  RUN_CONTAINER () {
      CMD='sudo -A docker'
      which podman && CMD='podman'
      ${CMD} run -it --rm \
          --gpus 'all,"capabilities=compute,utility,video"' \
          --ipc host \
          --ulimit memlock=-1 \
          --ulimit stack=67108864 \
          --shm-size 107374182400 \
          --mount 'type=tmpfs,destination=/data/TMPFS,tmpfs-size=137438953472' \
          -v "CACHE:/root/.cache" \
          -v "CACHE:/root/.triton" \
          -p "0.0.0.0:${LISTEN_PORT}:${LISTEN_PORT}/tcp" \
          -v "$(realpath .):/data" \
          "${IMAGE_NAME}" zsh ;
  }
#+end_src

* Scripts to build and run

** Build image

*** Add file to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'image_build.sh'
#+end_src

*** Actual script
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./image_build.sh
  cd "$(dirname -- "${0}")"
  . './host.image_names.sh'
  BUILD_CONTAINER
#+end_src

** Run image

*** Add file to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'image_run.sh'
#+end_src

*** Actual script
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./image_run.sh
  cd "$(dirname -- "${0}")"
  . './host.image_names.sh'
  RUN_CONTAINER
#+end_src

* Prepare and add the dockerfile to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'Dockerfile'
#+end_src

* Main base image
#+begin_src conf :tangle ./Dockerfile
  FROM debtestrustzshhelixpytorch
#+end_src

* Download and install libtorch

** Install apt stuff
#+begin_src conf :tangle ./Dockerfile
  RUN \
        --mount=target=/var/lib/apt/lists,type=cache,sharing=locked \
        --mount=target=/var/cache/apt,type=cache,sharing=locked \
        echo 'START apt-get stuff' \
        && apt-get -y update \
        && apt-get install -y \
            'aria2' \
            'automake' \
            'bear' \
            'bison' \
            'build-essential' \
            'clang' \
            'cmake' \
            'curl' \
            'gawk' \
            'gettext' \
            'git' \
            'git-lfs' \
            'libevent-dev' \
            'liblz4-dev' \
            'liblzo2-dev' \
            'libpcre2-16-0' \
            'libpcre2-32-0' \
            'libpcre2-8-0' \
            'libpcre2-dev' \
            'libpcre2-posix3' \
            'libssl-dev' \
            'libzstd-dev' \
            'make' \
            'neovim' \
            'ninja-build' \
            'pkg-config' \
            'python3-newt' \
            'python3-sphinx' \
            'squashfs-tools' \
            'unzip' \
            'wget' \
            'yacc' \
            'zip' \
        && echo 'DONE apt-get stuff' ;
#+end_src

* Installing python packages

** Basic updates
#+begin_src conf :tangle ./Dockerfile
  RUN \
      echo 'START pip' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install -U \
          'ipython' \
          'ninja' \
          'packaging' \
          'pip' \
          'psutil' \
          'setuptools' \
          'wheel' \
      && echo 'DONE pip' ;
#+end_src

** Main torch
#+begin_src conf :tangle ./Dockerfile
  RUN \
      echo 'START pytorch' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install \
          '--index-url' 'https://download.pytorch.org/whl/cu128' \
              'torch' \
              'torchao' \
              'torchvision' \
              'xformers' \
      && echo 'DONE pytorch' ;
#+end_src

** COMMENT Flash attn
This is just horrible to build!
#+begin_src conf :tangle ./Dockerfile
  RUN \
      echo 'START flash attn' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install \
              '--no-build-isolation' \
                  'flash-attn' \
      && echo 'DONE flash attn' ;
#+end_src

** Quantization, optimization and offloading
#+begin_src conf :tangle ./Dockerfile
  RUN \
      echo 'START Quantization, optimization and offloading' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install \
          'accelerate' \
          'albumentations' \
          'datasets' \
          'deepspeed' \
          'diffusers' \
          'einops' \
          'evaluate' \
          'fastapi[standard]' \
          'fastexcel' \
          'huggingface-hub' \
          'inotify-simple' \
          'ipython' \
          'ipywidgets' \
          'jupyter' \
          'jupyterlab' \
          'lightning[extra]' \
          'matplotlib' \
          'opencv_contrib_python' \
          'opencv_python' \
          'openvino' \
          'optimum' \
          'optimum-quanto' \
          'packaging' \
          'pillow' \
          'prodigyopt' \
          'protobuf' \
          'requests' \
          'safetensors' \
          'scikit-learn' \
          'sentencepiece' \
          'torch_dct' \
          'torchao' \
          'torchmetrics' \
          'tqdm' \
          'transformers' \
          'ultralytics' \
          'urllib3' \
          'wandb' \
      && echo 'DONE Quantization, optimization and offloading' ;
#+end_src

* Clone and install from source

** Transformers
#+begin_src conf :tangle ./Dockerfile
  RUN \
      echo 'START transformers source install' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/transformers.git' \
      && uv pip install -e . \
      && echo 'DONE transformers source install' ;
#+end_src

** Huggingface hub
#+begin_src conf :tangle ./Dockerfile
  RUN \
      echo 'START huggingface-hub source install' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/huggingface_hub.git' \
      && uv pip install -e . \
      && echo 'DONE huggingface-hub source install' ;
#+end_src

** pytorch video
#+begin_src conf :tangle ./Dockerfile
  RUN \
      echo 'START pytorch video source install' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/facebookresearch/pytorchvideo.git' \
      && uv pip install -e . \
      && echo 'DONE pytorch video source install' ;
#+end_src

** Diffusers
#+begin_src conf :tangle ./Dockerfile
  RUN \
      echo 'START diffusers install from source' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/diffusers.git' \
      && uv pip install -e . \
      && echo 'DONE diffusers install from source' ;
#+end_src

** TIMM
#+begin_src conf :tangle ./Dockerfile
  RUN \
      echo 'START TIMM install from source' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/pytorch-image-models.git' \
      && uv pip install -e . \
      && echo 'DONE TIMM install from source' ;
#+end_src

** DOCTR
#+begin_src conf :tangle ./Dockerfile
  RUN \
      echo 'START doctr install from source' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/mindee/doctr.git' \
      && uv pip install -e . \
      && echo 'DONE doctr install from source' ;
#+end_src

* onnxscript and runtime
#+begin_src conf :tangle ./Dockerfile
  RUN \
      echo 'START onnxstuff' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install \
              'onnxruntime-gpu' \
              'onnxscript' \
      && echo 'DONE onnxstuff' ;
#+end_src

* COMMENT Huggingface hub
#+begin_src conf :tangle ./Dockerfile
  RUN \
      echo 'START Hub' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install \
              'huggingface-hub' \
      && echo 'DONE Hub' ;
#+end_src

* COMMENT work space
#+begin_src emacs-lisp :results silent
  (save-buffer)
  (org-babel-tangle)
  (async-shell-command "
      './.git.sh'
  " "log" "err")
#+end_src
