* Scripts to manage
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  . '../../../shell_functions/important_functions.sh'
  GITADD 'README.org'
  P_CLEAN '.git.sh'
  P_CLEAN 'README.org~'
#+end_src

* Prepare and add the docker functions file to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'host.image_names.sh'
#+end_src

* Host scripts

** Important envs
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  IMAGE_NAME='debtestrustbuild'
#+end_src

** Important functions

*** Build image
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  BUILD_CONTAINER () {
      CMD='sudo -A docker'
      which buildah && CMD='buildah'
      cp '../../../shell_functions/important_functions.sh' ./
      ${CMD} build -t "${IMAGE_NAME}" -f "./Dockerfile" .
  }
#+end_src

*** Run image
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  RUN_CONTAINER () {
      CMD='sudo -A docker'
      which podman && CMD='podman'
      mkdir -pv -- in out

      ${CMD} run -it --rm \
          -v "$(realpath .):/data" \
          -v "$(realpath .)/in:/root/GITHUB" \
          -v "$(realpath .)/in:/root/GITLAB" \
          -v "$(realpath .)/out:/var/tmp/" \
          "${IMAGE_NAME}" bash ;
  }
#+end_src

* Scripts to build and run

** Build image

*** Add file to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'image_build.sh'
#+end_src

*** Actual script
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./image_build.sh
  cd "$(dirname -- "${0}")"
  . './host.image_names.sh'
  BUILD_CONTAINER
#+end_src

** Run image

*** Add file to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'image_run.sh'
#+end_src

*** Actual script
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./image_run.sh
  cd "$(dirname -- "${0}")"
  . './host.image_names.sh'
  RUN_CONTAINER
#+end_src

* Prepare and add the dockerfile to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'Dockerfile'
#+end_src

* Basic image config

** Main base image
#+begin_src conf :tangle ./Dockerfile
  FROM debtestrust
#+end_src

** Copy the Important functions (script to source) and source it
#+begin_src conf :tangle ./Dockerfile
  COPY './important_functions.sh' '/root/important_functions.sh'
#+end_src

* Main command to run in the container
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  IMAGE_CMD='bash'
#+end_src

* Script to install packages to /usr/local

** Add the install script to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD './install.sh'
  GITADD './install_all.sh'
  GITADD './compress.sh'
#+end_src

** Copy the script into the image
#+begin_src conf :tangle ./Dockerfile
  COPY './install.sh' '/root/install.sh'
  COPY './install_all.sh' '/root/install_all.sh'
  COPY './compress.sh' '/root/compress.sh'
#+end_src

** Actual script
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./install.sh
  cd "$(dirname -- "${0}")"
  exec cp -aspf -- "$(realpath ./bin)" '/usr/local/'
#+end_src

** Copy the scripts to the final dirs
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./install_all.sh
  cd "$(dirname -- "${0}")"
  ls /var/tmp/* -d | sed 's@^@("cp" "-vf" "./install.sh" "@g;s@$@");@g' | sh
#+end_src

** Script to compress
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./compress.sh
  cd "$('dirname' '--' "${0}")"
  OUT="$('/bin/pwd').squashfs-zstd"
  'rm' '-vf' '--' "${OUT}"
  'mksquashfs' '.' "${OUT}"  '-comp' 'zstd' '-Xcompression-level' '18' '-b' '1048576' '-always-use-fragments' '-keep-as-directory' '-no-compression'
  exit '0'
#+end_src


* Important apt install stuff
#+begin_src conf :tangle ./Dockerfile
  RUN \
      --mount=target=/var/lib/apt/lists,type=cache,sharing=locked \
      --mount=target=/var/cache/apt,type=cache,sharing=locked \
      echo 'START apt-get stuff' \
      && apt-get -y update \
      && apt-get install -y \
          'aria2' \
          'automake' \
          'bear' \
          'bison' \
          'build-essential' \
          'clang' \
          'cmake' \
          'curl' \
          'ffmpeg' \
          'gawk' \
          'gettext' \
          'git' \
          'git-lfs' \
          'libevent-dev' \
          'liblz4-dev' \
          'liblzo2-dev' \
          'libpcre2-16-0' \
          'libpcre2-32-0' \
          'libpcre2-8-0' \
          'libpcre2-dev' \
          'libpcre2-posix3' \
          'libssl-dev' \
          'libzstd-dev' \
          'make' \
          'nasm' \
          'neovim' \
          'ninja-build' \
          'pkg-config' \
          'python3-newt' \
          'python3-sphinx' \
          'squashfs-tools' \
          'unzip' \
          'wget' \
          'yacc' \
          'zip' \
      && echo 'DONE apt-get stuff' ;
#+end_src

* COMMENT Work space
#+begin_src emacs-lisp :results silent
  (save-buffer)
  (org-babel-tangle)
  (async-shell-command "
      './.git.sh'
  " "log" "err")
#+end_src
