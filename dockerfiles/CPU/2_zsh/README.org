* Scripts to manage
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  . '../../../shell_functions/important_functions.sh'
  GITADD 'README.org'
  P_CLEAN '.git.sh'
  P_CLEAN 'README.org~'
#+end_src

* Prepare and add the docker functions file to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'host.image_names.sh'
#+end_src

* Host scripts

** Important envs
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  IMAGE_NAME='debtestrustzsh'
#+end_src

** Important functions

*** Build image
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  BUILD_CONTAINER () {
      CMD='sudo -A docker'
      which buildah && CMD='buildah'
      ${CMD} build -t "${IMAGE_NAME}" -f "./Dockerfile"
  }
#+end_src

*** Run image
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  RUN_CONTAINER () {
      CMD='sudo -A docker'
      which podman && CMD='podman'
      ${CMD} run -it --rm -v "$(realpath .):/data" "${IMAGE_NAME}" zsh
  }
#+end_src

* Scripts to build and run

** Build image

*** Add file to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'image_build.sh'
#+end_src

*** Actual script
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./image_build.sh
  cd "$(dirname -- "${0}")"
  . './host.image_names.sh'
  BUILD_CONTAINER
#+end_src

** Run image

*** Add file to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'image_run.sh'
#+end_src

*** Actual script
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./image_run.sh
  cd "$(dirname -- "${0}")"
  . './host.image_names.sh'
  RUN_CONTAINER
#+end_src

* Prepare and add the dockerfile to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'Dockerfile'
#+end_src

* Basic image config

** Main base image
#+begin_src conf :tangle ./Dockerfile
  FROM debtestrustbuild
#+end_src

* Install zsh

** Install tools to download and install rust
#+begin_src conf :tangle ./Dockerfile
  RUN \
      --mount=target=/var/lib/apt/lists,type=cache,sharing=locked \
      --mount=target=/var/cache/apt,type=cache,sharing=locked \
      echo 'START apt-get stuff' \
      && apt-get -y update \
      && apt-get install -y \
          'build-essential' \
          'fish' \
          'fzf' \
          'git' \
          'zstd' \
          'zsh' \
      && echo 'DONE apt-get stuff' ;
#+end_src

** Get ohmyzsh

*** Download code
#+begin_src conf :tangle ./Dockerfile
  RUN \
      echo 'START ohmyzsh' \
      && git clone 'https://github.com/ohmyzsh/ohmyzsh.git' \
      && ln -vfs "${HOME}/ohmyzsh" "${HOME}/.oh-my-zsh" \
      && echo 'DONE ohmyzsh' ;
#+end_src

*** Add files to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'zshrc'
#+end_src

*** Actual script
#+begin_src conf :tangle ./zshrc
  export SHELL=zsh
  export ZSH="$HOME/.oh-my-zsh"
  export SUDO_ASKPASS="${HOME}/SUDO_ASKPASS"
  plugins=(eza fzf git starship vi-mode zoxide zsh-interactive-cd)
  source "${ZSH}/oh-my-zsh.sh"
#+end_src

*** Copy the file
#+begin_src conf :tangle ./Dockerfile
  ADD ./zshrc /root/.zshrc
#+end_src

* Add rust programs
#+begin_src conf :tangle ./Dockerfile
  RUN \
      echo 'START Downloading rust programs' \
      && cd '/var/tmp/' \
      && aria2c -c -x16 -j16 'https://github.com/aravindhv10/config_storage/releases/download/v1.0/out.tar.zst' \
      && zstd -d --long=30 './out.tar.zst' \
      && tar -xf './out.tar' \
      && mv out/* ./ \
      && rmdir -pv -- out \
      && rm -vf -- './out.tar' './out.tar.zst' \
      && echo 'DONE Downloading rust programs' ;

  RUN ls /var/tmp/*/install.sh | sh
#+end_src

* Add atuin
#+begin_src conf :tangle ./Dockerfile
  RUN atuin init zsh >> /root/.zshrc
#+end_src

* COMMENT work space
#+begin_src emacs-lisp :results silent
  (save-buffer)
  (org-babel-tangle)
  (async-shell-command "
      './.git.sh'
  " "log" "err")
#+end_src
