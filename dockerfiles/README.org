* Script to work
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  cd "$(dirname -- "${0}")"
#+end_src

#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  . '../shell_functions/important_functions.sh'
#+end_src

#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  CLEAN '.git.sh'
  CLEAN 'README.org~'
#+end_src

#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'build_container.sh'

  GITADD 'build_cpu.sh'
  GITADD 'build_cuda.sh'

  GITADD 'build_rocm_pytorch.sh'
  GITADD 'build_rocm.sh'

  GITADD 'README.org'

  GITADD 'run_cpu.sh'
  GITADD 'run_cuda.sh'
  GITADD 'run_rocm.sh'

  GITADD 'AMDGPU/0_base/Dockerfile'
  GITADD 'AMDGPU/5_libtorch/Dockerfile'
  GITADD 'AMDGPU/6_pytorch/Dockerfile'

  GITADD 'AMDGPU_PYT/0_base/Dockerfile'
  GITADD 'AMDGPU_PYT/5_libtorch/Dockerfile'
  GITADD 'AMDGPU_PYT/6_pytorch/Dockerfile'

  GITADD 'CPU/0_base/Dockerfile'
  GITADD 'CPU/1_install_packages/Dockerfile'
  GITADD 'CPU/2_install_rust/Dockerfile'
  GITADD 'CPU/3_good_setup/Dockerfile'
  GITADD 'CPU/4_python/Dockerfile'
  GITADD 'CPU/5_libtorch/Dockerfile'
  GITADD 'CPU/6_pytorch/Dockerfile'

  GITADD 'CUDA_UBUNTU/0_base/Dockerfile'
  GITADD 'CUDA_UBUNTU/5_libtorch/Dockerfile'
  GITADD 'CUDA_UBUNTU/6_pytorch/Dockerfile'
#+end_src

* Main build script
#+begin_src sh :shebang #!/bin/sh :results output :mkdirp yes :tangle ./build_container.sh
  cd "$('dirname' -- "${0}")"
  ln -vfs '../shell_functions/important_functions.sh' './'
  cp './important_functions.sh' "./${1}/"
  cd "./${1}/"
  IMAGE_NAME="$(basename -- "${1}")"
  mkdir -pv -- './build'
  H="$(cat './Dockerfile' './important_functions.sh' | sha512sum | cut -d ' ' -f1)"
  test -e "./build/${H}" && exit '0'
  CMD='sudo -A docker'
  which buildah && CMD='buildah'
  ${CMD} build -t "${IMAGE_NAME}" -f './Dockerfile' . && touch "./build/${H}"
  exit '0'
#+end_src

* Actual dockerfiles

** 0_base

*** CPU
#+begin_src conf :mkdirp yes :tangle ./CPU/0_base/Dockerfile
  FROM debian:testing-backports
#+end_src

*** CUDA_UBUNTU
#+begin_src conf :mkdirp yes :tangle ./CUDA_UBUNTU/0_base/Dockerfile
  FROM nvidia/cuda:12.8.1-cudnn-devel-ubuntu24.04
#+end_src

*** AMDGPU

**** Regular
#+begin_src conf :mkdirp yes :tangle ./AMDGPU/0_base/Dockerfile
  FROM rocm/dev-ubuntu-24.04:6.4.4-complete
#+end_src

**** Pytorch

***** Main base image
#+begin_src conf :mkdirp yes :tangle ./AMDGPU_PYT/0_base/Dockerfile
  FROM rocm/pytorch:rocm7.1_ubuntu24.04_py3.13_pytorch_release_2.9.1
#+end_src

***** provide default python venv for use later
#+begin_src conf :mkdirp yes :tangle ./AMDGPU_PYT/0_base/Dockerfile
  RUN ln -vfs -- '../opt/venv' '/root/venv'
#+end_src

***** Copy important functions script
#+begin_src conf :mkdirp yes :tangle ./AMDGPU_PYT/0_base/Dockerfile
  COPY './important_functions.sh' '/root/important_functions.sh'
#+end_src

***** Install essential rocm packages
#+begin_src conf :mkdirp yes :tangle ./AMDGPU_PYT/0_base/Dockerfile
  RUN \
      --mount=target=/var/lib/apt/lists,type=cache,sharing=locked \
      --mount=target=/var/cache/apt,type=cache,sharing=locked \
      echo 'START apt-get update' \
      && . '/root/important_functions.sh' \
      && get_amd_rocm_packages_ubuntu \
      && echo 'DONE apt-get update' ;
#+end_src

** 1_install_packages

*** Base image
#+begin_src conf :mkdirp yes :tangle ./CPU/1_install_packages/Dockerfile
  FROM 0_base
#+end_src

*** Important env
#+begin_src conf :mkdirp yes :tangle ./CPU/1_install_packages/Dockerfile
  ENV HOME='/root'
  ENV DEBIAN_FRONTEND='noninteractive'
  WORKDIR '/root'
  USER root
#+end_src

*** Copy important functions
#+begin_src conf :mkdirp yes :tangle ./CPU/1_install_packages/Dockerfile
  COPY './important_functions.sh' '/root/important_functions.sh'
#+end_src

*** Install common packages
#+begin_src conf :mkdirp yes :tangle ./CPU/1_install_packages/Dockerfile
  RUN \
      --mount=target=/var/lib/apt/lists,type=cache,sharing=locked \
      --mount=target=/var/cache/apt,type=cache,sharing=locked \
      echo 'START apt-get update' \
      && apt-get update \
      && . '/root/important_functions.sh' \
      && get_apt_packages \
      && echo 'DONE apt-get update' ;
#+end_src

** 2_install_rust

*** Base image
#+begin_src conf :mkdirp yes :tangle ./CPU/2_install_rust/Dockerfile
  FROM 1_install_packages
#+end_src

*** Setting env
#+begin_src conf :mkdirp yes :tangle ./CPU/2_install_rust/Dockerfile
  ENV RUSTUP_HOME='/usr/local/rustup'
  ENV CARGO_HOME='/usr/local/cargo'
  ENV PATH="/usr/local/cargo/bin:${PATH}"
#+end_src

*** Download and install rust
#+begin_src conf :mkdirp yes :tangle ./CPU/2_install_rust/Dockerfile
  RUN \
      --mount=target=/root/SHA512SUM,type=cache \
      --mount=target=/root/TMP,type=cache \
      echo 'START Download and install rust' \
      && . "${HOME}/important_functions.sh" \
      && adown \
          'https://sh.rustup.rs' \
          'rustup.rs' \
          'b44833a5cc74448c8ace263bea5499b9dccd0b3b5ad08bbd6c5aafcefe7f421a77d04cdf0e24f1e19de0bf4ff93e170d035665ea10afd3eb228a1633ad13dfaa' \
          "${HOME}/rustup-init.sh" \
      && cd "${HOME}" \
      && chmod +x 'rustup-init.sh' \
      && './rustup-init.sh' '-y' '--no-modify-path' \
      && echo 'DONE Download and install rust'
#+end_src

*** Install additional rust components
#+begin_src conf :mkdirp yes :tangle ./CPU/2_install_rust/Dockerfile
  RUN rustup component add rust-src
  RUN rustup component add rust-analyzer
  RUN rustup component add rustfmt
#+end_src

** 3_good_setup

*** The base image
#+begin_src conf :mkdirp yes :tangle ./CPU/3_good_setup/Dockerfile
  FROM 2_install_rust
#+end_src

*** Copy important functions shell script
#+begin_src conf :mkdirp yes :tangle ./CPU/3_good_setup/Dockerfile
  COPY './important_functions.sh' '/root/important_functions.sh'
#+end_src

*** Configure zsh and other stuff
#+begin_src conf :mkdirp yes :tangle ./CPU/3_good_setup/Dockerfile
  RUN \
      --mount=target=/root/SHA512SUM,type=cache \
      --mount=target=/root/TMP,type=cache \
      echo 'START Download and install rust programs' \
      && . "${HOME}/important_functions.sh" \
      && get_all_good_programs_and_config \
      && echo 'DONE Download and install rust programs' ;
#+end_src

** 4_python

*** The base image
#+begin_src conf :mkdirp yes :tangle ./CPU/4_python/Dockerfile
  FROM 3_good_setup
#+end_src

*** Setup venv if it does not already exist
#+begin_src conf :mkdirp yes :tangle ./CPU/4_python/Dockerfile
  RUN test -e "${HOME}/venv" || uv venv "${HOME}/venv"
  ENV PATH="/root/venv/bin:${PATH}"
  ENV VIRTUAL_ENV="${HOME}/venv"
  ENV VIRTUAL_ENV_PROMPT='venv'
#+end_src

** 5_libtorch

*** CPU
#+begin_src conf :mkdirp yes :tangle ./CPU/5_libtorch/Dockerfile
  FROM 4_python

  COPY './important_functions.sh' '/root/important_functions.sh'

  RUN \
      --mount=target=/root/SHA512SUM,type=cache \
      --mount=target=/root/TMP,type=cache \
      echo 'START Download and install libtorch' \
      && . "${HOME}/important_functions.sh" \
      && adown \
          'https://download.pytorch.org/libtorch/cpu/libtorch-shared-with-deps-2.9.1%2Bcpu.zip' \
          'libtorch.zip' \
          '86cd32e4c4a1e8810b1e7596cfa52341e16ab220e4a602bfbefa6af3227bac5cf83aa7372ffb1e787c893653a4c77a549c7e8c2e850ca9cbc325008d5f0b5237' \
          "${HOME}/libtorch.zip" \
      && cd "${HOME}" \
      && unzip './libtorch.zip' \
      && cd libtorch \
      && cd lib \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/lib/");@g' | sh \
      && cd .. \
      && cd include \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/include/");@g' | sh \
      && cd .. \
      && cd share/cmake \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/share/cmake");@g' | sh \
      && cd ../.. \
      && cd .. \
      && echo 'DONE Download and install libtorch' ;

  ENV LIBTORCH="/usr/"
#+end_src

*** CUDA_UBUNTU
#+begin_src conf :mkdirp yes :tangle ./CUDA_UBUNTU/5_libtorch/Dockerfile
  FROM 4_python

  COPY './important_functions.sh' '/root/important_functions.sh'

  RUN \
      --mount=target=/root/SHA512SUM,type=cache \
      --mount=target=/root/TMP,type=cache \
      echo 'START Download and install libtorch' \
      && . "${HOME}/important_functions.sh" \
      && adown \
          'https://download.pytorch.org/libtorch/cu128/libtorch-shared-with-deps-2.9.1%2Bcu128.zip' \
          'libtorch.zip' \
          'ffbe0d9e3250cdcfc6f2fe8498e6b41a6e0949cbf048fb6e430b96bc4eda1a39d9857612fca487c30840572b1e51f4534d36b42bd0924b9ee7ec3bfb6f27c204' \
          "${HOME}/libtorch.zip" \
      && cd "${HOME}" \
      && unzip './libtorch.zip' \
      && cd libtorch \
      && cd lib \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/lib/");@g' | sh \
      && cd .. \
      && cd include \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/include/");@g' | sh \
      && cd .. \
      && cd share/cmake \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/share/cmake");@g' | sh \
      && cd ../.. \
      && cd .. \
      && echo 'DONE Download and install libtorch' ;

  ENV LIBTORCH="/usr/"
#+end_src

*** AMDGPU

**** Pytorch

***** Base parts
#+begin_src conf :mkdirp yes :tangle ./AMDGPU_PYT/5_libtorch/Dockerfile
  FROM 4_python
  COPY './important_functions.sh' '/root/important_functions.sh'
  ENV CMAKE_PREFIX_PATH='/opt/venv/lib/python3.13/site-packages/torch/share/cmake'
  ENV LD_LIBRARY_PATH="/opt/venv/lib/python3.13/site-packages/torch/lib:${LD_LIBRARY_PATH}"
  ENV LIBTORCH='/opt/venv/lib/python3.13/site-packages/torch'
#+end_src

***** COMMENT Pytorch
#+begin_src conf :mkdirp yes :tangle ./AMDGPU_PYT/5_libtorch/Dockerfile
  RUN \
      --mount=target=/root/SHA512SUM,type=cache \
      --mount=target=/root/TMP,type=cache \
      echo 'START Download and install libtorch' \
      && . "${HOME}/important_functions.sh" \
      && cd '/opt/venv/lib/python3.13/site-packages/torch' \
      && cd lib \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/lib/");@g' | sh \
      && cd .. \
      && cd include \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/include/");@g' | sh \
      && cd .. \
      && cd share/cmake \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/share/cmake");@g' | sh \
      && cd ../.. \
      && cd .. \
      && echo 'DONE Download and install libtorch' ;
#+end_src

**** Regular
#+begin_src conf :mkdirp yes :tangle ./AMDGPU/5_libtorch/Dockerfile
  FROM 4_python

  COPY './important_functions.sh' '/root/important_functions.sh'

  RUN \
      --mount=target=/root/SHA512SUM,type=cache \
      --mount=target=/root/TMP,type=cache \
      echo 'START Download and install libtorch' \
      && . "${HOME}/important_functions.sh" \
      && adown \
          'https://download.pytorch.org/libtorch/rocm6.4/libtorch-shared-with-deps-2.9.1%2Brocm6.4.zip' \
          'libtorch.zip' \
          '0cd40a87997d418dbcd5d2e7550d608b5cd44d241b7409118142311d434c32c247e1a96b80ee9bd7b4cf70c53b8bd43e0bf7078c1cecf07445dfcebf438e6486' \
          "${HOME}/libtorch.zip" \
      && cd "${HOME}" \
      && unzip './libtorch.zip' \
      && cd libtorch \
      && cd lib \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/lib/");@g' | sh \
      && cd .. \
      && cd include \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/include/");@g' | sh \
      && cd .. \
      && cd share/cmake \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/share/cmake");@g' | sh \
      && cd ../.. \
      && cd .. \
      && echo 'DONE Download and install libtorch' ;

  ENV LIBTORCH="/usr/"
#+end_src

** 6_pytorch

*** CPU
#+begin_src conf :mkdirp yes :tangle ./CPU/6_pytorch/Dockerfile
  FROM 5_libtorch

  COPY './important_functions.sh' '/root/important_functions.sh'

  RUN \
      echo 'START pip' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install -U \
          'ipython' \
          'ninja' \
          'packaging' \
          'pip' \
          'setuptools' \
          'wheel' \
      && echo 'DONE pip' ;

  RUN \
      echo 'START pip' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install -U \
          '--index-url' 'https://download.pytorch.org/whl/cpu' \
              'torch' \
              'torchvision' \
      && echo 'DONE pip' ;

  RUN \
      echo 'START pip' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install \
          'einops' \
          'timm' \
      && echo 'DONE pip' ;

  RUN \
      echo 'START onnxstuff' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install \
          'grpcio' \
          'grpcio-tools' \
          'onnxruntime' \
          'onnxscript' \
      && echo 'DONE onnxstuff' ;
#+end_src

*** CUDA_UBUNTU
#+begin_src conf :mkdirp yes :tangle ./CUDA_UBUNTU/6_pytorch/Dockerfile
  FROM 5_libtorch

  COPY './important_functions.sh' '/root/important_functions.sh'

  RUN \
      echo 'START pip' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install -U \
          'ipython' \
          'ninja' \
          'packaging' \
          'pip' \
          'psutil' \
          'setuptools' \
          'wheel' \
      && echo 'DONE pip' ;

  RUN \
      echo 'START pytorch' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install \
          '--index-url' 'https://download.pytorch.org/whl/cu128' \
              'torch' \
              'torch-tensorrt' \
              'torchao' \
              'torchvision' \
              'xformers' \
      && echo 'DONE pytorch' ;

  RUN \
      echo 'START Quantization, optimization and offloading' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install \
          'accelerate' \
          'albumentations' \
          'datasets' \
          'deepspeed' \
          'diffusers' \
          'einops' \
          'evaluate' \
          'fastapi[standard]' \
          'fastexcel' \
          'inotify-simple' \
          'ipython' \
          'ipywidgets' \
          'jupyter' \
          'jupyterlab' \
          'lightning[extra]' \
          'matplotlib' \
          'opencv_contrib_python' \
          'opencv_python' \
          'openvino' \
          'optimum' \
          'optimum-quanto' \
          'packaging' \
          'pillow' \
          'prodigyopt' \
          'protobuf' \
          'requests' \
          'safetensors' \
          'scikit-learn' \
          'sentencepiece' \
          'torch_dct' \
          'torchmetrics' \
          'tqdm' \
          'transformers' \
          'ultralytics' \
          'urllib3' \
          'wandb' \
      && echo 'DONE Quantization, optimization and offloading' ;

  RUN \
      echo 'START pytorch video source install' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/facebookresearch/pytorchvideo.git' \
      && uv pip install -e . \
      && echo 'DONE pytorch video source install' ;

  RUN \
      echo 'START diffusers install from source' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/diffusers.git' \
      && uv pip install -e . \
      && echo 'DONE diffusers install from source' ;

  RUN \
      echo 'START transformers source install' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/transformers.git' \
      && uv pip install -e . \
      && echo 'DONE transformers source install' ;

  RUN \
      echo 'START TIMM install from source' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/pytorch-image-models.git' \
      && uv pip install -e . \
      && echo 'DONE TIMM install from source' ;

  RUN \
      echo 'START huggingface-hub source install' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/huggingface_hub.git' \
      && uv pip install -e . \
      && echo 'DONE huggingface-hub source install' ;

  RUN \
      echo 'START onnxstuff' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install \
          'grpcio' \
          'grpcio-tools' \
          'onnxruntime-gpu' \
          'onnxscript' \
      && echo 'DONE onnxstuff' ;
#+end_src

uv pip install torch  --extra-index-url https://download.pytorch.org/whl/cu118

*** AMDGPU

**** Pytorch
#+begin_src conf :mkdirp yes :tangle ./AMDGPU_PYT/6_pytorch/Dockerfile
  FROM 5_libtorch

  COPY './important_functions.sh' '/root/important_functions.sh'

  RUN \
      echo 'START pip' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install \
          'ipython' \
          'ninja' \
          'packaging' \
          'pip' \
          'psutil' \
          'setuptools' \
          'wheel' \
      && echo 'DONE pip' ;

  RUN \
      echo 'START Quantization, optimization and offloading' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install \
          'accelerate' \
          'albumentations' \
          'datasets' \
          'deepspeed' \
          'diffusers' \
          'einops' \
          'evaluate' \
          'fastapi[standard]' \
          'fastexcel' \
          'inotify-simple' \
          'ipython' \
          'ipywidgets' \
          'jupyter' \
          'jupyterlab' \
          'lightning[extra]' \
          'matplotlib' \
          'opencv_contrib_python' \
          'opencv_python' \
          'openvino' \
          'optimum' \
          'optimum-quanto' \
          'packaging' \
          'pillow' \
          'prodigyopt' \
          'protobuf' \
          'requests' \
          'safetensors' \
          'scikit-learn' \
          'sentencepiece' \
          'torch_dct' \
          'torchmetrics' \
          'tqdm' \
          'transformers' \
          'ultralytics' \
          'urllib3' \
          'wandb' \
      && echo 'DONE Quantization, optimization and offloading' ;

  RUN \
      echo 'START pytorch video source install' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/facebookresearch/pytorchvideo.git' \
      && uv pip install -e . \
      && echo 'DONE pytorch video source install' ;

  RUN \
      echo 'START diffusers install from source' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/diffusers.git' \
      && uv pip install -e . \
      && echo 'DONE diffusers install from source' ;

  RUN \
      echo 'START transformers source install' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/transformers.git' \
      && uv pip install -e . \
      && echo 'DONE transformers source install' ;

  RUN \
      echo 'START TIMM install from source' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/pytorch-image-models.git' \
      && uv pip install -e . \
      && echo 'DONE TIMM install from source' ;

  RUN \
      echo 'START huggingface-hub source install' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/huggingface_hub.git' \
      && uv pip install -e . \
      && echo 'DONE huggingface-hub source install' ;


  RUN \
      echo 'START onnxstuff' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install \
          'grpcio' \
          'grpcio-tools' \
          'onnxruntime' \
          'onnxscript' \
      && echo 'DONE onnxstuff' ;
#+end_src

**** Regular
#+begin_src conf :mkdirp yes :tangle ./AMDGPU/6_pytorch/Dockerfile
  FROM 5_libtorch

  COPY './important_functions.sh' '/root/important_functions.sh'

  RUN \
      echo 'START pip' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install -U \
          'ipython' \
          'ninja' \
          'packaging' \
          'pip' \
          'psutil' \
          'setuptools' \
          'wheel' \
      && echo 'DONE pip' ;

  RUN \
      echo 'START pip' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install -U \
          '--index-url' 'https://download.pytorch.org/whl/rocm6.4' \
              'torch' \
              'torchvision' \
      && echo 'DONE pip' ;

  RUN \
      echo 'START Quantization, optimization and offloading' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install \
          'accelerate' \
          'albumentations' \
          'datasets' \
          'deepspeed' \
          'diffusers' \
          'einops' \
          'evaluate' \
          'fastapi[standard]' \
          'fastexcel' \
          'inotify-simple' \
          'ipython' \
          'ipywidgets' \
          'jupyter' \
          'jupyterlab' \
          'lightning[extra]' \
          'matplotlib' \
          'opencv_contrib_python' \
          'opencv_python' \
          'openvino' \
          'optimum' \
          'optimum-quanto' \
          'packaging' \
          'pillow' \
          'prodigyopt' \
          'protobuf' \
          'requests' \
          'safetensors' \
          'scikit-learn' \
          'sentencepiece' \
          'torch_dct' \
          'torchmetrics' \
          'tqdm' \
          'transformers' \
          'ultralytics' \
          'urllib3' \
          'wandb' \
      && echo 'DONE Quantization, optimization and offloading' ;

  RUN \
      echo 'START pytorch video source install' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/facebookresearch/pytorchvideo.git' \
      && uv pip install -e . \
      && echo 'DONE pytorch video source install' ;

  RUN \
      echo 'START diffusers install from source' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/diffusers.git' \
      && uv pip install -e . \
      && echo 'DONE diffusers install from source' ;

  RUN \
      echo 'START transformers source install' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/transformers.git' \
      && uv pip install -e . \
      && echo 'DONE transformers source install' ;

  RUN \
      echo 'START TIMM install from source' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/pytorch-image-models.git' \
      && uv pip install -e . \
      && echo 'DONE TIMM install from source' ;

  RUN \
      echo 'START huggingface-hub source install' \
      && . "${HOME}/important_functions.sh" \
      && get_repo 'https://github.com/huggingface/huggingface_hub.git' \
      && uv pip install -e . \
      && echo 'DONE huggingface-hub source install' ;

  RUN \
      echo 'START onnxstuff' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install \
          'grpcio' \
          'grpcio-tools' \
          'onnxruntime' \
          'onnxscript' \
      && echo 'DONE onnxstuff' ;
#+end_src

* Script to build images

** CPU
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./build_cpu.sh
cd "$(dirname -- "${0}")"
'./build_container.sh' 'CPU/0_base'
'./build_container.sh' 'CPU/1_install_packages'
'./build_container.sh' 'CPU/2_install_rust'
'./build_container.sh' 'CPU/3_good_setup'
'./build_container.sh' 'CPU/4_python'
'./build_container.sh' 'CPU/5_libtorch'
'./build_container.sh' 'CPU/6_pytorch'
exit '0'
#+end_src

** CUDA_UBUNTU
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./build_cuda.sh
cd "$(dirname -- "${0}")"
'./build_container.sh' 'CUDA_UBUNTU/0_base'
'./build_container.sh' 'CPU/1_install_packages'
'./build_container.sh' 'CPU/2_install_rust'
'./build_container.sh' 'CPU/3_good_setup'
'./build_container.sh' 'CPU/4_python'
'./build_container.sh' 'CUDA_UBUNTU/5_libtorch'
'./build_container.sh' 'CUDA_UBUNTU/6_pytorch'
exit '0'
#+end_src

** AMDGPU

*** Regular
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./build_rocm.sh
cd "$(dirname -- "${0}")"
'./build_container.sh' 'AMDGPU/0_base'
'./build_container.sh' 'CPU/1_install_packages'
'./build_container.sh' 'CPU/2_install_rust'
'./build_container.sh' 'CPU/3_good_setup'
'./build_container.sh' 'CPU/4_python'
'./build_container.sh' 'AMDGPU/5_libtorch'
'./build_container.sh' 'AMDGPU/6_pytorch'
exit '0'
#+end_src

*** Pytorch
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./build_rocm_pytorch.sh
cd "$(dirname -- "${0}")"
'./build_container.sh' 'AMDGPU_PYT/0_base'
'./build_container.sh' 'CPU/1_install_packages'
'./build_container.sh' 'CPU/2_install_rust'
'./build_container.sh' 'CPU/3_good_setup'
'./build_container.sh' 'CPU/4_python'
'./build_container.sh' 'AMDGPU_PYT/5_libtorch'
'./build_container.sh' 'AMDGPU_PYT/6_pytorch'
exit '0'
#+end_src

* Script to run image

** AMDGPU
#+begin_src sh :shebang #!/bin/sh :results output :mkdirp yes :tangle ./run_rocm.sh
  cd "$('dirname' '--' "${0}")"
  IMAGE_NAME="$(basename -- "$(realpath -- .)")"
  podman run \
      -it --rm \
      '--device' '/dev/kfd' \
      '--device' '/dev/dri' \
      '--net' 'host' \
      '--security-opt' 'seccomp=unconfined' \
      --mount 'type=tmpfs,destination=/data/TMPFS,tmpfs-size=137438953472' \
      -v "$(realpath .):/data/source" \
      -v "${HOME}/BUILD:/data/build" \
      -v "CACHE:/usr/local/cargo/registry" \
      -v "CACHE:/root/.cache" \
      "${IMAGE_NAME}" zsh \
  ;
#+end_src

** CPU
#+begin_src sh :shebang #!/bin/sh :results output :mkdirp yes :tangle ./run_cpu.sh
  cd "$('dirname' '--' "${0}")"
  IMAGE_NAME="$(basename -- "$(realpath -- .)")"
  podman run \
      -it --rm \
      '--device' '/dev/dri' \
      '--net' 'host' \
      '--security-opt' 'seccomp=unconfined' \
      --mount 'type=tmpfs,destination=/data/TMPFS,tmpfs-size=137438953472' \
      -v "$(realpath .):/data/source" \
      -v "${HOME}/BUILD:/data/build" \
      -v "CACHE:/usr/local/cargo/registry" \
      -v "CACHE:/root/.cache" \
      "${IMAGE_NAME}" zsh \
  ;
#+end_src

** CUDA_UBUNTU
#+begin_src sh :shebang #!/bin/sh :results output :mkdirp yes :tangle ./run_cuda.sh
  cd "$('dirname' '--' "${0}")"
  IMAGE_NAME="$(basename -- "$(realpath -- .)")"
  MKDIR './input'
  MKDIR './output'
  MKDIR './model'
  INPUT="$(realpath ./input)"
  OUTPUT="$(realpath ./output)"
  MODEL="$(realpath ./model)"
  sudo -A docker run \
      --tty \
      --interactive \
      --rm \
      --gpus 'all,"capabilities=compute,utility,video"' \
      --ipc host \
      --ulimit memlock=-1 \
      --ulimit stack=67108864 \
      --shm-size 107374182400 \
      --mount 'type=tmpfs,destination=/data/TMPFS,tmpfs-size=137438953472' \
      -v "${INPUT}:/data/input" \
      -v "${OUTPUT}:/data/output" \
      -v "${MODEL}:/data/model" \
      -v "CACHE:/root/.cache" \
      -v "CACHE:/root/.triton" \
      -p "0.0.0.0:${LISTEN_PORT}:${LISTEN_PORT}/tcp" \
      "${IMAGE_NAME}" "${IMAGE_CMD}" \
  ;
#+end_src

* COMMENT Work space
#+begin_src emacs-lisp :results silent
  (save-buffer)
  (org-babel-tangle)
  (async-shell-command "
      './.git.sh'
  " "log" "err")
#+end_src
