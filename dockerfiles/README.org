* Script to work
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  cd "$(dirname -- "${0}")"
  . '../shell_functions/important_functions.sh'
  CLEAN '.git.sh'
  CLEAN 'README.org~'

  GITADD 'build_container.sh'
  GITADD 'build_cpu.sh'
  GITADD 'build_cuda.sh'
  GITADD 'build_rocm.sh'
  GITADD 'common_functions.sh'
  GITADD 'CPU/0_base/Dockerfile'
  GITADD 'CPU/1_rust_builder/Dockerfile'
  GITADD 'CPU/2_zsh/Dockerfile'
  GITADD 'CPU/3_helix/Dockerfile'
  GITADD 'CPU/4_python/Dockerfile'
  GITADD 'CPU/5_libtorch/Dockerfile'
  GITADD 'CPU/6_pytorch/Dockerfile'
  GITADD 'README.org'
#+end_src

* Main build script
#+begin_src sh :shebang #!/bin/sh :results output :mkdirp yes :tangle ./build_container.sh
  cd "$('dirname' -- "${0}")"
  ln -vfs '../shell_functions/important_functions.sh' './'
  cp './important_functions.sh' "./${1}/"
  cd "./${1}/"
  IMAGE_NAME="$(basename -- "${1}")"
  mkdir -pv -- './build'
  H="$(cat './Dockerfile' './important_functions.sh' | sha512sum | cut -d ' ' -f1)"
  test -e "./build/${H}" && exit '0'
  CMD='sudo -A docker'
  which buildah && CMD='buildah'
  ${CMD} build -t "${IMAGE_NAME}" -f './Dockerfile' . && touch "./build/${H}"
  exit '0'
#+end_src

* Actual dockerfiles

** For cpu

*** Base image
#+begin_src conf :mkdirp yes :tangle ./CPU/0_base/Dockerfile
  FROM debian:testing-backports
#+end_src

*** Installing rust
#+begin_src conf :mkdirp yes :tangle ./CPU/1_rust_builder/Dockerfile
  FROM 0_base

  ENV HOME='/root'
  ENV DEBIAN_FRONTEND='noninteractive'
  WORKDIR '/root'
  USER root

  COPY './important_functions.sh' '/root/important_functions.sh'

  RUN \
      --mount=target=/var/lib/apt/lists,type=cache,sharing=locked \
      --mount=target=/var/cache/apt,type=cache,sharing=locked \
      echo 'START apt-get update' \
      && apt-get update \
      && . '/root/important_functions.sh' \
      && get_apt_packages \
      && echo 'DONE apt-get update' ;

  ENV RUSTUP_HOME='/usr/local/rustup'
  ENV CARGO_HOME='/usr/local/cargo'
  ENV PATH="/usr/local/cargo/bin:${PATH}"
  ENV RUST_VERSION='1.91.1'

  RUN \
      --mount=target=/cache,type=cache,sharing=locked \
      set -eux; \
      mkdir -pv '/cache'; \
      cd '/cache'; \
      arch="$(dpkg --print-architecture)"; \
      case "$arch" in \
          'amd64') \
              rustArch='x86_64-unknown-linux-gnu'; \
              rustupSha256='20a06e644b0d9bd2fbdbfd52d42540bdde820ea7df86e92e533c073da0cdd43c'; \
              ;; \
          'armhf') \
              rustArch='armv7-unknown-linux-gnueabihf'; \
              rustupSha256='3b8daab6cc3135f2cd4b12919559e6adaee73a2fbefb830fadf0405c20231d61'; \
              ;; \
          'arm64') \
              rustArch='aarch64-unknown-linux-gnu'; \
              rustupSha256='e3853c5a252fca15252d07cb23a1bdd9377a8c6f3efa01531109281ae47f841c'; \
              ;; \
          'i386') \
              rustArch='i686-unknown-linux-gnu'; \
              rustupSha256='a5db2c4b29d23e9b318b955dd0337d6b52e93933608469085c924e0d05b1df1f'; \
              ;; \
          'ppc64el') \
              rustArch='powerpc64le-unknown-linux-gnu'; \
              rustupSha256='acd89c42b47c93bd4266163a7b05d3f26287d5148413c0d47b2e8a7aa67c9dc0'; \
              ;; \
          's390x') \
              rustArch='s390x-unknown-linux-gnu'; \
              rustupSha256='726b7fd5d8805e73eab4a024a2889f8859d5a44e36041abac0a2436a52d42572'; \
              ;; \
          'riscv64') \
              rustArch='riscv64gc-unknown-linux-gnu'; \
              rustupSha256='09e64cc1b7a3e99adaa15dd2d46a3aad9d44d71041e2a96100d165c98a8fd7a7'; \
              ;; \
          ,*) \
              echo >&2 "unsupported architecture: $arch"; \
              exit 1; \
              ;; \
      esac; \
      \
      url="https://static.rust-lang.org/rustup/archive/1.28.2/${rustArch}/rustup-init"; \
      wget --progress=dot:giga -c "$url"; \
      echo "${rustupSha256} *rustup-init" | sha256sum -c -; \
      \
      chmod +x rustup-init; \
      ./rustup-init -y --no-modify-path --profile minimal --default-toolchain $RUST_VERSION --default-host ${rustArch}; \
      chmod -R a+w $RUSTUP_HOME $CARGO_HOME; \
      \
      rustup --version; \
      cargo --version; \
      rustc --version;

  RUN rustup component add rust-src
  RUN rustup component add rust-analyzer
  RUN rustup component add rustfmt
#+end_src

*** Install and configure zsh
#+begin_src conf :mkdirp yes :tangle ./CPU/2_zsh/Dockerfile
  FROM 1_rust_builder

  COPY './important_functions.sh' '/root/important_functions.sh'

  RUN \
      --mount=target=/root/SHA512SUM,type=cache \
      --mount=target=/root/TMP,type=cache \
      echo 'START Download and install rust programs' \
      && . "${HOME}/important_functions.sh" \
      && get_all_good_programs_and_config \
      && echo 'DONE Download and install rust programs' ;
#+end_src

*** Helix wrapper
#+begin_src conf :mkdirp yes :tangle ./CPU/3_helix/Dockerfile
  FROM 2_zsh
#+end_src

*** Setting up basic python venv
#+begin_src conf :mkdirp yes :tangle ./CPU/4_python/Dockerfile
  FROM 3_helix

  RUN uv venv "${HOME}/venv"
  ENV PATH="/root/venv/bin:${PATH}"
  ENV VIRTUAL_ENV="${HOME}/venv"
  ENV VIRTUAL_ENV_PROMPT='venv'
#+end_src

*** Install libtorch for c++ and rust
#+begin_src conf :mkdirp yes :tangle ./CPU/5_libtorch/Dockerfile
  FROM 4_python

  COPY './important_functions.sh' '/root/important_functions.sh'

  RUN \
      --mount=target=/root/SHA512SUM,type=cache \
      --mount=target=/root/TMP,type=cache \
      echo 'START Download and install libtorch' \
      && . "${HOME}/important_functions.sh" \
      && adown \
          'https://download.pytorch.org/libtorch/cpu/libtorch-shared-with-deps-2.9.1%2Bcpu.zip' \
          'libtorch.zip' \
          '86cd32e4c4a1e8810b1e7596cfa52341e16ab220e4a602bfbefa6af3227bac5cf83aa7372ffb1e787c893653a4c77a549c7e8c2e850ca9cbc325008d5f0b5237' \
          "${HOME}/libtorch.zip" \
      && cd "${HOME}" \
      && unzip './libtorch.zip' \
      && cd libtorch \
      && cd lib \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/lib/");@g' | sh \
      && cd .. \
      && cd include \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/include/");@g' | sh \
      && cd .. \
      && cd share/cmake \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/share/cmake");@g' | sh \
      && cd ../.. \
      && cd .. \
      && echo 'DONE Download and install libtorch' ;

  ENV LIBTORCH="/usr/"
#+end_src

*** Install additional python packages
#+begin_src conf :mkdirp yes :tangle ./CPU/6_pytorch/Dockerfile
  FROM 5_libtorch

  COPY './important_functions.sh' '/root/important_functions.sh'

  RUN \
      echo 'START pip' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install -U \
          'ipython' \
          'ninja' \
          'packaging' \
          'pip' \
          'setuptools' \
          'wheel' \
      && echo 'DONE pip' ;

  RUN \
      echo 'START pip' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install -U \
          '--index-url' 'https://download.pytorch.org/whl/cpu' \
              'torch' \
              'torchvision' \
      && echo 'DONE pip' ;

  RUN \
      echo 'START pip' \
      && . "${HOME}/venv/bin/activate" \
      && uv pip install -U \
          'einops' \
          'timm' \
      && echo 'DONE pip' ;
#+end_src

* Build all cpu images
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./build_cpu.sh
  cd "$(dirname -- "${0}")"
  './build_container.sh' 'CPU/0_base'
  './build_container.sh' 'CPU/1_rust_builder'
  './build_container.sh' 'CPU/2_zsh'
  './build_container.sh' 'CPU/3_helix'
  './build_container.sh' 'CPU/4_python'
  './build_container.sh' 'CPU/5_libtorch'
  './build_container.sh' 'CPU/6_pytorch'
  exit '0'
#+end_src

* Build all cuda images
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./build_cuda.sh
  cd "$(dirname -- "${0}")"
  './CUDA_UBUNTU/0_base/image_build.sh'
  './CPU/1_rust_builder/image_build.sh'
  './CPU/2_zsh/image_build.sh'
  './CPU/3_helix/image_build.sh'
  './CPU/4_python/image_build.sh'
  './CUDA_UBUNTU/5_libtorch/image_build.sh'
  './CUDA_UBUNTU/6_pytorch/image_build.sh'
  exit '0'
#+end_src

* Build all rocm images
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./build_rocm.sh
  cd "$(dirname -- "${0}")"
  './AMDGPU/0_base/image_build.sh'
  './CPU/1_rust_builder/image_build.sh'
  './CPU/2_zsh/image_build.sh'
  './CPU/3_helix/image_build.sh'
  './CPU/4_python/image_build.sh'
  './AMDGPU/5_libtorch/image_build.sh'
  './AMDGPU/6_pytorch/image_build.sh'
  exit '0'
#+end_src

* Important common functions
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./common_functions.sh
  BUILD_CONTAINER () {
      cp '../../../shell_functions/important_functions.sh' ./
      CMD='sudo -A docker'
      which buildah && CMD='buildah'
      ${CMD} build -t "${IMAGE_NAME}" -f "./Dockerfile" .
  }
#+end_src

* COMMENT Work space
#+begin_src emacs-lisp :results silent
  (save-buffer)
  (org-babel-tangle)
  (async-shell-command "
      './.git.sh'
  " "log" "err")
#+end_src
