* Scripts to manage
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  . '../../../shell_functions/important_functions.sh'
  GITADD 'README.org'
  P_CLEAN '.git.sh'
  P_CLEAN 'README.org~'
#+end_src

* Prepare and add the docker functions file to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'host.image_names.sh'
#+end_src

* Host scripts

** Important envs
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  # IMAGE_NAME='debtestrustzshhelix'
  IMAGE_NAME='debtestrustzshhelixpytorch'
#+end_src

** Important functions

*** Build image
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  . '../../common_functions.sh'
#+end_src

*** Run image
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./host.image_names.sh
  RUN_CONTAINER () {
      CMD='sudo -A docker'
      which podman && CMD='podman'
      ${CMD} run \
          -it --rm \
          '--device' '/dev/kfd' \
          '--device' '/dev/dri' \
          '--security-opt' 'seccomp=unconfined' \
          -v "$(realpath .):/data" \
          "${IMAGE_NAME}" zsh \
      ;
  }
#+end_src

* Scripts to build and run

** Build image

*** Add file to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'image_build.sh'
#+end_src

*** Actual script
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./image_build.sh
  cd "$(dirname -- "${0}")"
  . './host.image_names.sh'
  BUILD_CONTAINER
#+end_src

** Run image

*** Add file to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'image_run.sh'
#+end_src

*** Actual script
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./image_run.sh
  cd "$(dirname -- "${0}")"
  . './host.image_names.sh'
  RUN_CONTAINER
#+end_src

* Prepare and add the dockerfile to git
#+begin_src sh :shebang #!/bin/sh :results output :tangle ./.git.sh
  GITADD 'Dockerfile'
#+end_src

* Main base image
#+begin_src conf :tangle ./Dockerfile
  FROM debtestrustzshhelixpy
#+end_src

** Copy the Important functions (script to source) and source it
#+begin_src conf :tangle ./Dockerfile
  COPY './important_functions.sh' '/root/important_functions.sh'
#+end_src

* Download and install libtorch

** Install apt stuff
#+begin_src conf :tangle ./Dockerfile
  RUN \
        --mount=target=/var/lib/apt/lists,type=cache,sharing=locked \
        --mount=target=/var/cache/apt,type=cache,sharing=locked \
        echo 'START apt-get stuff' \
        && apt-get install -y \
            'bear' \
            'zip' \
        && echo 'DONE apt-get stuff' ;
#+end_src

** Download and install libtorch
#+begin_src conf :tangle ./Dockerfile
  RUN \
      --mount=target=/root/SHA512SUM,type=cache \
      --mount=target=/root/TMP,type=cache \
      echo 'START Download and install libtorch' \
      && . "${HOME}/important_functions.sh" \
      && cd '/opt/venv/lib/python3.12/site-packages/torch' \
      && cd lib \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/lib/");@g' | sh \
      && cd .. \
      && cd include \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/include/");@g' | sh \
      && cd .. \
      && cd share/cmake \
      && ls | sed 's@^@(cp -vapf -- "@g;s@$@" "/usr/share/cmake");@g' | sh \
      && cd ../.. \
      && cd .. \
      && echo 'DONE Download and install libtorch' ;
#+end_src

** Set env to find libtorch
#+begin_src conf :tangle ./Dockerfile
  ENV LIBTORCH="/usr/"
#+end_src

* COMMENT work space
#+begin_src emacs-lisp :results silent
  (save-buffer)
  (org-babel-tangle)
  (async-shell-command "
      './.git.sh'
  " "log" "err")
#+end_src
